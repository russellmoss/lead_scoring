# Cursor.ai Prompt: Update V3.1 Lead Scoring Model to V3.2

## üéØ Objective

Update the deployed V3.1 rules-based lead scoring model to V3.2 by incorporating new high-converting signals discovered in data investigation. The changes are SQL-only updates to tier logic - no infrastructure changes needed.

---

## üìÅ Project Context

### Working Directory
```
C:\Users\russe\Documents\Lead Scoring\Version-3\
```

### Key Files to Modify
| File | Purpose | Action |
|------|---------|--------|
| `sql/phase_4_v3_tiered_scoring.sql` | Main tier assignment logic | **UPDATE** - New tier criteria |
| `sql/phase_7_production_view.sql` | Production scoring view | **UPDATE** - Match new tiers |
| `sql/phase_7_salesforce_sync.sql` | Salesforce sync query | **UPDATE** - Add new tier mappings |
| `sql/phase_7_sga_dashboard.sql` | SGA dashboard view | **UPDATE** - Add new tier displays |
| `data/raw/tier_statistics.json` | Tier calibration data | **REGENERATE** after validation |
| `models/model_registry_v3.json` | Model version registry | **UPDATE** version to v3.2 |

### Key Files to Read (Do NOT Modify)
| File | Purpose |
|------|---------|
| `sql/lead_scoring_features_pit.sql` | Feature engineering - check available fields |
| `date_config.json` | Date configuration for queries |
| `EXECUTION_LOG.md` | Execution history reference |

### BigQuery Tables
| Table | Dataset | Purpose |
|-------|---------|---------|
| `lead_scoring_features_pit` | `ml_features` | Source features table |
| `lead_scores_v3` | `ml_features` | Production scoring table (to update) |
| `tier_calibration_v3` | `ml_features` | Tier calibration (to update) |
| `lead_scoring_splits` | `ml_features` | Train/test splits |

---

## üìä Investigation Findings (Basis for Changes)

### Strongest Converting Signals (From 48,472 Lead Analysis)

| Signal | Conversion Rate | Lift vs Baseline | Current V3.1 Status |
|--------|-----------------|------------------|---------------------|
| **1-3 years tenure** | 15.76% | 3.7x | ‚ö†Ô∏è V3.1 uses 1-4 years (too wide) |
| **Small firm (1-10 reps)** | 14.59% | 3.5x | ‚ùå **MISSING from V3.1** |
| **Short tenure + Bleeding firm** | 14.42% | 3.4x | ‚úÖ Partially captured |
| **Moderate bleeding (-10 to -1)** | 11.00% | 2.6x | ‚úÖ Tier 2 has this |
| **3+ prior firms (career movers)** | 10.47% | 2.5x | ‚ùå **MISSING from V3.1** |
| **Heavy bleeding (< -10)** | 10.18% | 2.4x | ‚úÖ Tier 4 has this |

### Key Correction from V4 Document
**V4 was WRONG about tenure:**
- V4 claimed: < 1 year tenure converts best at 7.57%
- **Actual data:** < 1 year converts at 3.92% (WORSE than baseline!)
- **Actual best:** 1-3 years tenure at 15.76%
- **Action:** Target 1-3 years, NOT < 1 year

### Baseline Conversion Rate
- **Overall baseline:** 4.24%
- **Non-wirehouse baseline:** ~4.5%

---

## üîÑ Current V3.1 Tier Logic (What We're Replacing)

```sql
CASE 
    -- TIER 1: PRIME MOVERS (3.69x lift)
    WHEN tenure_years BETWEEN 1 AND 4
         AND experience_years BETWEEN 5 AND 15
         AND firm_net_change_12mo != 0
         AND is_wirehouse = 0
    THEN 'TIER_1_PRIME_MOVER'
    
    -- TIER 2: MODERATE BLEEDERS (2.30x lift)
    WHEN firm_net_change_12mo BETWEEN -10 AND -1
         AND experience_years >= 5
    THEN 'TIER_2_MODERATE_BLEEDER'
    
    -- TIER 3: EXPERIENCED MOVERS (2.98x lift)
    WHEN tenure_years BETWEEN 1 AND 4
         AND experience_years >= 20
    THEN 'TIER_3_EXPERIENCED_MOVER'
    
    -- TIER 4: HEAVY BLEEDERS (2.33x lift)
    WHEN firm_net_change_12mo < -10
         AND experience_years >= 5
    THEN 'TIER_4_HEAVY_BLEEDER'
    
    ELSE 'STANDARD'
END as score_tier
```

---

## ‚úÖ New V3.2 Tier Logic (Implement This)

```sql
CASE 
    -- ============================================================
    -- TIER 1A: PRIME MOVERS - SMALL FIRM (Expected ~15% conversion)
    -- Tightest criteria: short tenure + small bleeding firm
    -- ============================================================
    WHEN current_firm_tenure_months BETWEEN 12 AND 36  -- 1-3 years (tightened from 1-4)
         AND industry_tenure_months BETWEEN 60 AND 180  -- 5-15 years experience
         AND firm_net_change_12mo < 0                   -- Bleeding firm (changed from != 0)
         AND firm_rep_count_at_contact <= 50            -- Small/mid firm (NEW)
         AND is_wirehouse = 0
    THEN 'TIER_1A_PRIME_MOVER_SMALL'
    
    -- ============================================================
    -- TIER 1B: SMALL FIRM ADVISORS (Expected ~14% conversion)
    -- Very small firms convert well even without bleeding signal
    -- ============================================================
    WHEN current_firm_tenure_months BETWEEN 12 AND 36  -- 1-3 years tenure
         AND firm_rep_count_at_contact <= 10            -- Very small firm (NEW)
         AND is_wirehouse = 0
    THEN 'TIER_1B_SMALL_FIRM'
    
    -- ============================================================
    -- TIER 1C: PRIME MOVERS - ORIGINAL (Expected ~13% conversion)
    -- Original Tier 1 logic for larger firms
    -- ============================================================
    WHEN current_firm_tenure_months BETWEEN 12 AND 48  -- 1-4 years (original)
         AND industry_tenure_months BETWEEN 60 AND 180  -- 5-15 years experience
         AND firm_net_change_12mo < 0                   -- Bleeding firm
         AND is_wirehouse = 0
    THEN 'TIER_1C_PRIME_MOVER'
    
    -- ============================================================
    -- TIER 2A: PROVEN MOVERS (Expected ~10% conversion) - NEW
    -- Career movers who have changed firms 3+ times
    -- ============================================================
    WHEN num_prior_firms >= 3                           -- 3+ prior employers (NEW)
         AND industry_tenure_months >= 60               -- 5+ years experience
         AND is_wirehouse = 0
    THEN 'TIER_2A_PROVEN_MOVER'
    
    -- ============================================================
    -- TIER 2B: MODERATE BLEEDERS (Expected ~11% conversion)
    -- Firms losing 1-10 advisors (original Tier 2)
    -- ============================================================
    WHEN firm_net_change_12mo BETWEEN -10 AND -1
         AND industry_tenure_months >= 60               -- 5+ years experience
    THEN 'TIER_2B_MODERATE_BLEEDER'
    
    -- ============================================================
    -- TIER 3: EXPERIENCED MOVERS (Expected ~10% conversion)
    -- Veterans who recently moved (original Tier 3)
    -- ============================================================
    WHEN current_firm_tenure_months BETWEEN 12 AND 48  -- 1-4 years tenure
         AND industry_tenure_months >= 240              -- 20+ years experience
    THEN 'TIER_3_EXPERIENCED_MOVER'
    
    -- ============================================================
    -- TIER 4: HEAVY BLEEDERS (Expected ~10% conversion)
    -- Firms in crisis losing 10+ advisors (original Tier 4)
    -- ============================================================
    WHEN firm_net_change_12mo < -10
         AND industry_tenure_months >= 60               -- 5+ years experience
    THEN 'TIER_4_HEAVY_BLEEDER'
    
    -- ============================================================
    -- STANDARD: All other leads
    -- ============================================================
    ELSE 'STANDARD'
    
END as score_tier
```

---

## üìã Step-by-Step Implementation

### Step 1: Verify Feature Availability

First, check that required fields exist in the feature table:

```sql
-- Run this query to verify fields exist
SELECT 
  column_name
FROM `savvy-gtm-analytics.ml_features.INFORMATION_SCHEMA.COLUMNS`
WHERE table_name = 'lead_scoring_features_pit'
  AND column_name IN (
    'current_firm_tenure_months',
    'industry_tenure_months', 
    'firm_net_change_12mo',
    'firm_rep_count_at_contact',
    'num_prior_firms',
    'is_wirehouse'
  )
ORDER BY column_name;
```

**Expected result:** All 6 fields should exist. If `firm_rep_count_at_contact` or `num_prior_firms` are missing, check for alternate names like:
- `firm_rep_count_at_contact` might be `pit_firm_rep_count` or `firm_rep_count`
- `num_prior_firms` might be `pit_num_prior_firms` or `prior_firm_count`

**If fields are missing**, you need to add them to `sql/lead_scoring_features_pit.sql` first.

### Step 2: Preview New Tier Distribution (Validation Query)

Before making changes, run this preview query:

```sql
-- Preview V3.2 tier distribution on TRAINING data
WITH tier_preview AS (
  SELECT 
    *,
    CASE 
      WHEN current_firm_tenure_months BETWEEN 12 AND 36
           AND industry_tenure_months BETWEEN 60 AND 180
           AND firm_net_change_12mo < 0
           AND firm_rep_count_at_contact <= 50
           AND is_wirehouse = 0
      THEN 'TIER_1A_PRIME_MOVER_SMALL'
      
      WHEN current_firm_tenure_months BETWEEN 12 AND 36
           AND firm_rep_count_at_contact <= 10
           AND is_wirehouse = 0
      THEN 'TIER_1B_SMALL_FIRM'
      
      WHEN current_firm_tenure_months BETWEEN 12 AND 48
           AND industry_tenure_months BETWEEN 60 AND 180
           AND firm_net_change_12mo < 0
           AND is_wirehouse = 0
      THEN 'TIER_1C_PRIME_MOVER'
      
      WHEN num_prior_firms >= 3
           AND industry_tenure_months >= 60
           AND is_wirehouse = 0
      THEN 'TIER_2A_PROVEN_MOVER'
      
      WHEN firm_net_change_12mo BETWEEN -10 AND -1
           AND industry_tenure_months >= 60
      THEN 'TIER_2B_MODERATE_BLEEDER'
      
      WHEN current_firm_tenure_months BETWEEN 12 AND 48
           AND industry_tenure_months >= 240
      THEN 'TIER_3_EXPERIENCED_MOVER'
      
      WHEN firm_net_change_12mo < -10
           AND industry_tenure_months >= 60
      THEN 'TIER_4_HEAVY_BLEEDER'
      
      ELSE 'STANDARD'
    END as new_tier
  FROM `savvy-gtm-analytics.ml_features.lead_scoring_features_pit`
  WHERE split = 'TRAIN'
)
SELECT 
  new_tier,
  COUNT(*) as lead_count,
  SUM(CASE WHEN target = 1 THEN 1 ELSE 0 END) as conversions,
  ROUND(AVG(CAST(target AS FLOAT64)) * 100, 2) as conversion_rate_pct,
  ROUND(AVG(CAST(target AS FLOAT64)) / 0.0366 , 2) as lift_vs_baseline  -- 3.66% training baseline
FROM tier_preview
GROUP BY new_tier
ORDER BY conversion_rate_pct DESC;
```

**Expected Results:**
| Tier | Expected Conv Rate | Expected Lift |
|------|-------------------|---------------|
| TIER_1A_PRIME_MOVER_SMALL | 14-16% | 4.0x+ |
| TIER_1B_SMALL_FIRM | 12-14% | 3.5x+ |
| TIER_1C_PRIME_MOVER | 11-13% | 3.0x+ |
| TIER_2A_PROVEN_MOVER | 9-11% | 2.5x+ |
| TIER_2B_MODERATE_BLEEDER | 8-11% | 2.3x+ |
| TIER_3_EXPERIENCED_MOVER | 9-11% | 2.5x+ |
| TIER_4_HEAVY_BLEEDER | 8-10% | 2.3x+ |
| STANDARD | 3-4% | 1.0x |

**Validation Gates:**
- ‚úÖ All Tier 1 variants should have 10%+ conversion
- ‚úÖ All priority tiers should have 2x+ lift
- ‚úÖ Priority tier total volume should be 2,000-5,000 leads (5-15% of total)
- ‚ùå If any tier has < 50 leads, consider merging with another tier

### Step 3: Update `sql/phase_4_v3_tiered_scoring.sql`

Open the file and replace the tier CASE statement with the new V3.2 logic. The full file should look like:

```sql
-- ============================================================================
-- V3.2 TIERED LEAD SCORING
-- Updated: [TODAY'S DATE]
-- Changes: Added small firm signals, tightened tenure, added proven movers tier
-- ============================================================================

CREATE OR REPLACE TABLE `savvy-gtm-analytics.ml_features.lead_scores_v3` AS

WITH scored_leads AS (
  SELECT 
    f.*,
    
    -- V3.2 Tier Assignment
    CASE 
      -- TIER 1A: PRIME MOVERS - SMALL FIRM
      WHEN current_firm_tenure_months BETWEEN 12 AND 36
           AND industry_tenure_months BETWEEN 60 AND 180
           AND firm_net_change_12mo < 0
           AND firm_rep_count_at_contact <= 50
           AND is_wirehouse = 0
      THEN 'TIER_1A_PRIME_MOVER_SMALL'
      
      -- TIER 1B: SMALL FIRM ADVISORS
      WHEN current_firm_tenure_months BETWEEN 12 AND 36
           AND firm_rep_count_at_contact <= 10
           AND is_wirehouse = 0
      THEN 'TIER_1B_SMALL_FIRM'
      
      -- TIER 1C: PRIME MOVERS - ORIGINAL
      WHEN current_firm_tenure_months BETWEEN 12 AND 48
           AND industry_tenure_months BETWEEN 60 AND 180
           AND firm_net_change_12mo < 0
           AND is_wirehouse = 0
      THEN 'TIER_1C_PRIME_MOVER'
      
      -- TIER 2A: PROVEN MOVERS
      WHEN num_prior_firms >= 3
           AND industry_tenure_months >= 60
           AND is_wirehouse = 0
      THEN 'TIER_2A_PROVEN_MOVER'
      
      -- TIER 2B: MODERATE BLEEDERS
      WHEN firm_net_change_12mo BETWEEN -10 AND -1
           AND industry_tenure_months >= 60
      THEN 'TIER_2B_MODERATE_BLEEDER'
      
      -- TIER 3: EXPERIENCED MOVERS
      WHEN current_firm_tenure_months BETWEEN 12 AND 48
           AND industry_tenure_months >= 240
      THEN 'TIER_3_EXPERIENCED_MOVER'
      
      -- TIER 4: HEAVY BLEEDERS
      WHEN firm_net_change_12mo < -10
           AND industry_tenure_months >= 60
      THEN 'TIER_4_HEAVY_BLEEDER'
      
      ELSE 'STANDARD'
    END as score_tier,
    
    -- Tier Display Names (for SGA dashboard)
    CASE 
      WHEN score_tier = 'TIER_1A_PRIME_MOVER_SMALL' THEN 'ü•á Prime Mover (Small Firm)'
      WHEN score_tier = 'TIER_1B_SMALL_FIRM' THEN 'ü•á Small Firm Advisor'
      WHEN score_tier = 'TIER_1C_PRIME_MOVER' THEN 'ü•á Prime Mover'
      WHEN score_tier = 'TIER_2A_PROVEN_MOVER' THEN 'ü•à Proven Mover'
      WHEN score_tier = 'TIER_2B_MODERATE_BLEEDER' THEN 'ü•à Moderate Bleeder'
      WHEN score_tier = 'TIER_3_EXPERIENCED_MOVER' THEN 'ü•â Experienced Mover'
      WHEN score_tier = 'TIER_4_HEAVY_BLEEDER' THEN 'üéñÔ∏è Heavy Bleeder'
      ELSE 'Standard'
    END as tier_display,
    
    -- Expected Conversion Rate (calibrated)
    CASE 
      WHEN score_tier = 'TIER_1A_PRIME_MOVER_SMALL' THEN 0.15
      WHEN score_tier = 'TIER_1B_SMALL_FIRM' THEN 0.14
      WHEN score_tier = 'TIER_1C_PRIME_MOVER' THEN 0.13
      WHEN score_tier = 'TIER_2A_PROVEN_MOVER' THEN 0.10
      WHEN score_tier = 'TIER_2B_MODERATE_BLEEDER' THEN 0.11
      WHEN score_tier = 'TIER_3_EXPERIENCED_MOVER' THEN 0.10
      WHEN score_tier = 'TIER_4_HEAVY_BLEEDER' THEN 0.10
      ELSE 0.04
    END as expected_conversion_rate,
    
    -- Expected Lift
    CASE 
      WHEN score_tier LIKE 'TIER_1%' THEN 3.5
      WHEN score_tier LIKE 'TIER_2%' THEN 2.5
      WHEN score_tier = 'TIER_3_EXPERIENCED_MOVER' THEN 2.5
      WHEN score_tier = 'TIER_4_HEAVY_BLEEDER' THEN 2.3
      ELSE 1.0
    END as expected_lift,
    
    -- Priority Ranking (for sorting)
    CASE 
      WHEN score_tier = 'TIER_1A_PRIME_MOVER_SMALL' THEN 1
      WHEN score_tier = 'TIER_1B_SMALL_FIRM' THEN 2
      WHEN score_tier = 'TIER_1C_PRIME_MOVER' THEN 3
      WHEN score_tier = 'TIER_2A_PROVEN_MOVER' THEN 4
      WHEN score_tier = 'TIER_2B_MODERATE_BLEEDER' THEN 5
      WHEN score_tier = 'TIER_3_EXPERIENCED_MOVER' THEN 6
      WHEN score_tier = 'TIER_4_HEAVY_BLEEDER' THEN 7
      ELSE 99
    END as priority_rank,
    
    -- Action Recommended
    CASE 
      WHEN score_tier LIKE 'TIER_1%' THEN 'Call immediately - highest priority'
      WHEN score_tier LIKE 'TIER_2%' THEN 'Priority outreach within 24 hours'
      WHEN score_tier IN ('TIER_3_EXPERIENCED_MOVER', 'TIER_4_HEAVY_BLEEDER') THEN 'Priority follow-up this week'
      ELSE 'Standard outreach cadence'
    END as action_recommended,
    
    -- Tier Explanation (for sales team)
    CASE 
      WHEN score_tier = 'TIER_1A_PRIME_MOVER_SMALL' THEN 
        'Mid-career advisor (1-3yr tenure, 5-15yr exp) at small bleeding firm - highest conversion signal'
      WHEN score_tier = 'TIER_1B_SMALL_FIRM' THEN 
        'Recent joiner at very small firm (<10 reps) - high portability signal'
      WHEN score_tier = 'TIER_1C_PRIME_MOVER' THEN 
        'Mid-career advisor at bleeding firm - proven high-converting segment'
      WHEN score_tier = 'TIER_2A_PROVEN_MOVER' THEN 
        'Has changed firms 3+ times - demonstrated willingness to move'
      WHEN score_tier = 'TIER_2B_MODERATE_BLEEDER' THEN 
        'Experienced advisor at firm losing 1-10 reps - instability signal'
      WHEN score_tier = 'TIER_3_EXPERIENCED_MOVER' THEN 
        'Veteran (20+ yrs) who recently moved - has broken inertia'
      WHEN score_tier = 'TIER_4_HEAVY_BLEEDER' THEN 
        'Experienced advisor at firm in crisis (losing 10+ reps)'
      ELSE 'Standard lead - no priority signals detected'
    END as tier_explanation,
    
    CURRENT_TIMESTAMP() as scored_at,
    'v3.2' as model_version
    
  FROM `savvy-gtm-analytics.ml_features.lead_scoring_features_pit` f
)

SELECT * FROM scored_leads;
```

### Step 4: Update `sql/phase_7_production_view.sql`

Update the production view to include new tier mappings:

```sql
-- V3.2 Production View
CREATE OR REPLACE VIEW `savvy-gtm-analytics.ml_features.lead_scores_v3_current` AS
SELECT 
  lead_id,
  advisor_crd,
  contacted_date,
  score_tier,
  tier_display,
  expected_conversion_rate,
  expected_lift,
  priority_rank,
  action_recommended,
  tier_explanation,
  -- Include key features for transparency
  current_firm_tenure_months,
  industry_tenure_months,
  firm_net_change_12mo,
  firm_rep_count_at_contact,
  num_prior_firms,
  is_wirehouse,
  scored_at,
  model_version
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3`
WHERE score_tier != 'STANDARD'  -- Only priority leads in this view
ORDER BY priority_rank, expected_conversion_rate DESC;
```

### Step 5: Update `sql/phase_7_salesforce_sync.sql`

Add new tier mappings for Salesforce:

```sql
-- V3.2 Salesforce Sync Query
SELECT 
  lead_id as Lead_ID__c,
  score_tier as Lead_Score_Tier__c,
  tier_display as Lead_Score_Display__c,
  CAST(expected_conversion_rate * 100 AS STRING) || '%' as Expected_Conversion__c,
  CAST(expected_lift AS STRING) || 'x' as Expected_Lift__c,
  priority_rank as Lead_Priority_Rank__c,
  action_recommended as Lead_Action__c,
  tier_explanation as Lead_Score_Explanation__c,
  model_version as Lead_Score_Model__c,
  scored_at as Lead_Scored_At__c
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3`
WHERE score_tier != 'STANDARD';
```

### Step 6: Update `sql/phase_7_sga_dashboard.sql`

```sql
-- V3.2 SGA Dashboard View
CREATE OR REPLACE VIEW `savvy-gtm-analytics.ml_features.sga_priority_leads_v3` AS
SELECT 
  -- Lead Info
  lead_id,
  advisor_crd,
  contacted_date,
  
  -- Tier Info
  tier_display as Priority,
  action_recommended as Action,
  tier_explanation as Why_Prioritized,
  
  -- Expected Performance
  ROUND(expected_conversion_rate * 100, 1) as Expected_Conv_Pct,
  expected_lift as Lift_vs_Baseline,
  
  -- Key Signals (transparency for sales team)
  ROUND(current_firm_tenure_months / 12.0, 1) as Tenure_Years,
  ROUND(industry_tenure_months / 12.0, 0) as Experience_Years,
  firm_net_change_12mo as Firm_Net_Change,
  firm_rep_count_at_contact as Firm_Size,
  num_prior_firms as Prior_Firms,
  
  -- Scoring metadata
  scored_at,
  model_version

FROM `savvy-gtm-analytics.ml_features.lead_scores_v3`
WHERE score_tier != 'STANDARD'
ORDER BY priority_rank, expected_conversion_rate DESC;
```

### Step 7: Update Model Registry

Update `models/model_registry_v3.json`:

```json
{
  "model_id": "lead-scoring-v3.2",
  "model_version": "v3.2-updated-20251222",
  "model_type": "rules-based-tiers",
  "status": "production",
  "created_date": "[TODAY'S DATE]",
  "updated_date": "[TODAY'S DATE]",
  "changes_from_v3.1": [
    "Added firm_rep_count signal (small firms convert 3.5x better)",
    "Added num_prior_firms signal (3+ moves = 2.5x lift)",
    "Tightened Tier 1 tenure from 1-4yr to 1-3yr",
    "Split Tier 1 into 1A/1B/1C for granular prioritization",
    "Added TIER_2A_PROVEN_MOVER for career changers",
    "Changed bleeding criterion from != 0 to < 0"
  ],
  "expected_performance": {
    "tier_1a_lift": "4.0x",
    "tier_1b_lift": "3.5x", 
    "tier_1c_lift": "3.0x",
    "tier_2a_lift": "2.5x",
    "tier_2b_lift": "2.5x",
    "tier_3_lift": "2.5x",
    "tier_4_lift": "2.3x"
  },
  "training_data": {
    "start_date": "2024-02-01",
    "end_date": "2025-07-03",
    "total_leads": 30727,
    "baseline_conversion": "3.66%"
  },
  "tables": {
    "features": "ml_features.lead_scoring_features_pit",
    "scores": "ml_features.lead_scores_v3",
    "calibration": "ml_features.tier_calibration_v3"
  }
}
```

### Step 8: Run Validation Queries

After updating, run these validation queries:

#### 8a. Tier Distribution Check
```sql
-- Check new tier distribution
SELECT 
  score_tier,
  COUNT(*) as leads,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as pct_of_total
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3`
GROUP BY score_tier
ORDER BY 
  CASE 
    WHEN score_tier LIKE 'TIER_1%' THEN 1
    WHEN score_tier LIKE 'TIER_2%' THEN 2
    WHEN score_tier LIKE 'TIER_3%' THEN 3
    WHEN score_tier LIKE 'TIER_4%' THEN 4
    ELSE 5
  END;
```

**Validation Gate:** Priority tiers (non-STANDARD) should be 5-15% of total.

#### 8b. Conversion Rate Validation (Training Data)
```sql
-- Validate conversion rates on training data
SELECT 
  s.score_tier,
  COUNT(*) as leads,
  SUM(CASE WHEN f.target = 1 THEN 1 ELSE 0 END) as conversions,
  ROUND(AVG(CAST(f.target AS FLOAT64)) * 100, 2) as actual_conv_pct,
  ROUND(AVG(s.expected_conversion_rate) * 100, 2) as expected_conv_pct,
  ROUND(AVG(CAST(f.target AS FLOAT64)) / 0.0366, 2) as actual_lift
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` s
JOIN `savvy-gtm-analytics.ml_features.lead_scoring_features_pit` f
  ON s.lead_id = f.lead_id
WHERE f.split = 'TRAIN'
GROUP BY s.score_tier
ORDER BY actual_conv_pct DESC;
```

**Validation Gates:**
- ‚úÖ All Tier 1 variants: actual_conv_pct >= 10%
- ‚úÖ All Tier 2 variants: actual_conv_pct >= 8%
- ‚úÖ All priority tiers: actual_lift >= 2.0x
- ‚úÖ actual_conv_pct within 20% of expected_conv_pct

#### 8c. Test Data Validation
```sql
-- Validate on held-out test data
SELECT 
  s.score_tier,
  COUNT(*) as leads,
  SUM(CASE WHEN f.target = 1 THEN 1 ELSE 0 END) as conversions,
  ROUND(AVG(CAST(f.target AS FLOAT64)) * 100, 2) as test_conv_pct,
  ROUND(AVG(CAST(f.target AS FLOAT64)) / 0.0416, 2) as test_lift  -- 4.16% test baseline
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` s
JOIN `savvy-gtm-analytics.ml_features.lead_scoring_features_pit` f
  ON s.lead_id = f.lead_id
WHERE f.split = 'TEST'
GROUP BY s.score_tier
ORDER BY test_conv_pct DESC;
```

**Validation Gate:** Test lift should be within 50% of training lift (some degradation expected).

#### 8d. Statistical Significance Check
```sql
-- Calculate 95% confidence intervals
SELECT 
  score_tier,
  COUNT(*) as n,
  AVG(CAST(target AS FLOAT64)) as conv_rate,
  AVG(CAST(target AS FLOAT64)) - 1.96 * SQRT(AVG(CAST(target AS FLOAT64)) * (1 - AVG(CAST(target AS FLOAT64))) / COUNT(*)) as ci_lower,
  AVG(CAST(target AS FLOAT64)) + 1.96 * SQRT(AVG(CAST(target AS FLOAT64)) * (1 - AVG(CAST(target AS FLOAT64))) / COUNT(*)) as ci_upper
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` s
JOIN `savvy-gtm-analytics.ml_features.lead_scoring_features_pit` f
  ON s.lead_id = f.lead_id
WHERE f.split = 'TRAIN'
GROUP BY score_tier
HAVING COUNT(*) >= 30  -- Need minimum sample size
ORDER BY conv_rate DESC;
```

**Validation Gate:** Priority tier CI lower bounds should NOT overlap with STANDARD CI upper bound.

### Step 9: Update Calibration Table

```sql
-- Update tier calibration table
CREATE OR REPLACE TABLE `savvy-gtm-analytics.ml_features.tier_calibration_v3` AS
SELECT 
  score_tier,
  COUNT(*) as training_volume,
  ROUND(AVG(CAST(target AS FLOAT64)), 4) as calibrated_conversion_rate,
  ROUND(AVG(CAST(target AS FLOAT64)) / 0.0366, 2) as calibrated_lift,
  CURRENT_TIMESTAMP() as calibrated_at,
  'v3.2' as model_version
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` s
JOIN `savvy-gtm-analytics.ml_features.lead_scoring_features_pit` f
  ON s.lead_id = f.lead_id
WHERE f.split = 'TRAIN'
GROUP BY score_tier;
```

### Step 10: Update EXECUTION_LOG.md

Add a new entry to `EXECUTION_LOG.md`:

```markdown
---

## Phase V3.2: Tier Logic Update

**Executed:** [TODAY'S DATE AND TIME]
**Duration:** X minutes
**Status:** ‚úÖ PASSED / ‚ö†Ô∏è PASSED WITH WARNINGS / ‚ùå FAILED

### What We Did
- Updated tier logic based on data investigation findings
- Added firm size signal (firm_rep_count <= 50 for Tier 1A, <= 10 for Tier 1B)
- Added proven mover signal (num_prior_firms >= 3)
- Tightened tenure criteria from 1-4yr to 1-3yr for top tiers
- Split Tier 1 into 1A/1B/1C for granular prioritization
- Added TIER_2A_PROVEN_MOVER for career changers

### Files Modified
| File | Changes |
|------|---------|
| `sql/phase_4_v3_tiered_scoring.sql` | New V3.2 tier logic |
| `sql/phase_7_production_view.sql` | Updated view with new tiers |
| `sql/phase_7_salesforce_sync.sql` | Added new tier mappings |
| `sql/phase_7_sga_dashboard.sql` | Updated dashboard view |
| `models/model_registry_v3.json` | Updated to v3.2 |

### Validation Gates
| Gate ID | Check | Result | Notes |
|---------|-------|--------|-------|
| V3.2.1 | Tier 1A Conversion >= 10% | [RESULT] | [ACTUAL VALUE] |
| V3.2.2 | Tier 1B Conversion >= 10% | [RESULT] | [ACTUAL VALUE] |
| V3.2.3 | All Priority Tiers Lift >= 2.0x | [RESULT] | [ACTUAL VALUE] |
| V3.2.4 | Priority Tier Volume 5-15% | [RESULT] | [ACTUAL VALUE] |
| V3.2.5 | No CI Overlap with Baseline | [RESULT] | [DETAILS] |

### Key Metrics
- **TIER_1A_PRIME_MOVER_SMALL - Count:** X
- **TIER_1A_PRIME_MOVER_SMALL - Conversion Rate:** X%
- **TIER_1A_PRIME_MOVER_SMALL - Lift:** X.Xx
- [Continue for all tiers...]

### What We Learned
- [Document any unexpected findings]

### Next Steps
- Monitor production performance for 2-4 weeks
- Compare V3.2 vs V3.1 conversion rates
- Adjust calibration if needed

---
```

---

## ‚ö†Ô∏è Potential Issues & Solutions

### Issue 1: `firm_rep_count_at_contact` field doesn't exist

**Solution:** Check for alternate names:
```sql
SELECT column_name 
FROM `savvy-gtm-analytics.ml_features.INFORMATION_SCHEMA.COLUMNS`
WHERE table_name = 'lead_scoring_features_pit'
  AND column_name LIKE '%rep%count%' OR column_name LIKE '%firm%size%';
```

If not found, add to `sql/lead_scoring_features_pit.sql`:
```sql
-- Add to feature engineering SQL
fh.REP_COUNT as firm_rep_count_at_contact,
```

### Issue 2: `num_prior_firms` field doesn't exist

**Solution:** Check for alternate names or calculate from employment history:
```sql
-- Check existing columns
SELECT column_name 
FROM `savvy-gtm-analytics.ml_features.INFORMATION_SCHEMA.COLUMNS`
WHERE table_name = 'lead_scoring_features_pit'
  AND column_name LIKE '%prior%' OR column_name LIKE '%firms%';
```

If not found, this feature should already exist from V3.1 but might be named differently (e.g., `pit_num_prior_firms`).

### Issue 3: New tiers have too few leads

**Solution:** If any tier has < 50 leads, merge with similar tier:
- Merge TIER_1A + TIER_1B if either is too small
- Merge TIER_2A + TIER_2B if either is too small

### Issue 4: Conversion rate lower than expected

**Solution:** Check if criteria are too restrictive. Consider loosening:
- Firm size: Try <= 100 instead of <= 50
- Tenure: Try 1-4yr instead of 1-3yr
- Prior firms: Try >= 2 instead of >= 3

---

## üìä Expected Outcomes

After successful implementation:

| Metric | V3.1 Value | V3.2 Expected |
|--------|------------|---------------|
| Tier 1 Lift | 3.69x | **4.0x+** |
| Tier 1 Volume | 163 leads | 300-500 leads |
| Total Priority Volume | 1,804 leads | 2,500-4,000 leads |
| Coverage of Best Signals | ~60% | **~90%** |

---

## ‚úÖ Completion Checklist

- [ ] Step 1: Verified all required fields exist in feature table
- [ ] Step 2: Ran preview query, results match expectations
- [ ] Step 3: Updated `sql/phase_4_v3_tiered_scoring.sql`
- [ ] Step 4: Updated `sql/phase_7_production_view.sql`
- [ ] Step 5: Updated `sql/phase_7_salesforce_sync.sql`
- [ ] Step 6: Updated `sql/phase_7_sga_dashboard.sql`
- [ ] Step 7: Updated `models/model_registry_v3.json`
- [ ] Step 8a: Tier distribution validation passed
- [ ] Step 8b: Training conversion rate validation passed
- [ ] Step 8c: Test data validation passed
- [ ] Step 8d: Statistical significance validation passed
- [ ] Step 9: Updated calibration table
- [ ] Step 10: Updated EXECUTION_LOG.md
- [ ] All validation gates passed
- [ ] Changes committed to version control

---

**End of Prompt**
